<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Turnera Online | Luminance Studio by Cande</title>
    <meta name="description" content="Sistema de reserva de turnos online - Luminance Studio by Cande. Reserva tu tratamiento de belleza en l√≠nea.">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Playfair+Display:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- FullCalendar CSS -->
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css' rel='stylesheet' />
    
    <style>
        /* ===== VARIABLES Y ESTILOS GLOBALES ===== */
        :root {
            --rosa-claro: #f8d7e6;
            --rosa-medio: #e75480;
            --rosa-fuerte: #d81b60;
            --lila-claro: #f4f0ff;
            --lila-medio: #9c89b8;
            --lila-oscuro: #7b4bbd;
            --violeta: #6a4c93;
            --dorado: #d4af37;
            --dorado-claro: #f1c40f;
            --blanco: #ffffff;
            --gris-claro: #f8f9fa;
            --gris-medio: #e9ecef;
            --gris-oscuro: #6c757d;
            --texto-oscuro: #2d3436;
            --texto-medio: #636e72;
            --verde: #28a745;
            --rojo: #dc3545;
            --naranja: #fd7e14;
            --sombra: 0 10px 30px rgba(0, 0, 0, 0.08);
            --sombra-hover: 0 20px 40px rgba(0, 0, 0, 0.12);
            --transicion: all 0.3s ease;
            --border-radius: 15px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--gris-claro);
            color: var(--texto-oscuro);
            line-height: 1.6;
        }
        
        h1, h2, h3, h4 {
            font-family: 'Playfair Display', serif;
            font-weight: 700;
            line-height: 1.2;
            margin-bottom: 1rem;
        }
        
        .container {
            width: 90%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        /* ===== HEADER ===== */
        .header-turnera {
            background: linear-gradient(135deg, var(--rosa-claro) 0%, var(--lila-claro) 100%);
            padding: 30px 0;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .logo-turnera {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .logo-turnera a {
            text-decoration: none;
        }
        
        .logo-text {
            font-family: 'Playfair Display', serif;
            font-size: 28px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--rosa-fuerte), var(--lila-oscuro));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        .logo-subtitle {
            font-size: 12px;
            color: var(--texto-medio);
            letter-spacing: 1px;
            text-transform: uppercase;
        }
        
        .logo-dot {
            color: var(--dorado);
        }
        
        .btn-volver {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: var(--blanco);
            color: var(--rosa-fuerte);
            text-decoration: none;
            border-radius: 50px;
            font-weight: 600;
            transition: var(--transicion);
            box-shadow: var(--sombra);
        }
        
        .btn-volver:hover {
            transform: translateY(-3px);
            box-shadow: var(--sombra-hover);
        }
        
        /* ===== MAIN CONTENT ===== */
        .main-turnera {
            padding: 40px 0;
            min-height: calc(100vh - 200px);
        }
        
        .turnera-title {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .turnera-title h1 {
            font-size: 2.5rem;
            color: var(--violeta);
            margin-bottom: 15px;
        }
        
        .turnera-title p {
            color: var(--texto-medio);
            max-width: 600px;
            margin: 0 auto;
        }

        /* ===== STEPPER / PASOS ===== */
        .stepper {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 40px;
            padding: 20px;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--sombra);
        }

        .step {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--gris-medio);
            color: var(--texto-medio);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            transition: var(--transicion);
        }

        .step.active .step-number {
            background: linear-gradient(135deg, var(--rosa-medio), var(--rosa-fuerte));
            color: white;
        }

        .step.completed .step-number {
            background: var(--verde);
            color: white;
        }

        .step-label {
            font-weight: 600;
            color: var(--texto-medio);
        }

        .step.active .step-label {
            color: var(--rosa-medio);
        }

        .step-arrow {
            color: var(--gris-medio);
            font-size: 1.2rem;
        }
        
        /* ===== CALENDARIO - EVENTOS ===== */
        .fc-event {
            cursor: default !important;
            font-size: 0.7rem;
        }

        .fc-event.fc-event-occupied {
            background: #dc3545 !important;
            border-color: #bd2130 !important;
        }

        .fc-event.fc-event-pending {
            background: #ffc107 !important;
            border-color: #e0a800 !important;
        }

        .fc-event-title {
            font-weight: 600;
        }
        
        /* ===== SECCIONES ===== */
        .section-box {
            background-color: var(--blanco);
            border-radius: var(--border-radius);
            padding: 30px;
            box-shadow: var(--sombra);
            margin-bottom: 30px;
        }

        .section-box.disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--gris-claro);
        }

        .section-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--rosa-medio), var(--lila-oscuro));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }

        .section-header h2 {
            margin: 0;
            color: var(--violeta);
        }

        /* ===== CALENDARIO ===== */
        #calendar {
            margin-bottom: 20px;
        }

        /* Customizaci√≥n de FullCalendar */
        .fc {
            font-family: 'Poppins', sans-serif !important;
        }
        
        .fc-button {
            background: linear-gradient(135deg, var(--rosa-medio), var(--rosa-fuerte)) !important;
            border: none !important;
            text-transform: capitalize !important;
        }
        
        .fc-button:hover {
            background: linear-gradient(135deg, var(--rosa-fuerte), var(--lila-oscuro)) !important;
        }
        
        .fc-day-today {
            background-color: rgba(231, 84, 128, 0.1) !important;
        }

        .fc-daygrid-day.selected-date {
            background-color: rgba(231, 84, 128, 0.3) !important;
            border: 2px solid var(--rosa-medio) !important;
        }

        .fc-daygrid-day:hover {
            background-color: rgba(231, 84, 128, 0.1);
            cursor: pointer;
        }

        /* ===== SELECTOR DE SERVICIO ===== */
        .service-selector {
            display: grid;
            gap: 15px;
        }

        .service-option {
            padding: 20px;
            border: 2px solid var(--gris-medio);
            border-radius: 10px;
            cursor: pointer;
            transition: var(--transicion);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .service-option:hover {
            border-color: var(--rosa-medio);
            background: var(--lila-claro);
        }

        .service-option.selected {
            border-color: var(--rosa-medio);
            background: linear-gradient(135deg, var(--rosa-claro), var(--lila-claro));
        }

        .service-info h4 {
            color: var(--violeta);
            margin-bottom: 5px;
        }

        .service-details {
            display: flex;
            gap: 15px;
            color: var(--texto-medio);
            font-size: 0.9rem;
        }

        .service-price {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--rosa-medio);
        }

        /* ===== HORARIOS ===== */
        .time-slots {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
        }

        .time-slot {
            padding: 15px;
            border: 2px solid var(--gris-medio);
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: var(--transicion);
            font-weight: 600;
            background: white;
        }

        .time-slot:hover {
            border-color: var(--lila-medio);
            background: var(--lila-claro);
        }

        .time-slot.selected {
            border-color: var(--rosa-medio);
            background: linear-gradient(135deg, var(--rosa-medio), var(--rosa-fuerte));
            color: white;
        }

        .time-slot.unavailable {
            opacity: 0.3;
            cursor: not-allowed;
            background: var(--gris-claro);
        }

        /* ===== RESUMEN ===== */
        .summary-box {
            background: linear-gradient(135deg, var(--lila-claro), var(--rosa-claro));
            padding: 25px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .summary-label {
            font-weight: 600;
            color: var(--texto-oscuro);
        }

        .summary-value {
            color: var(--rosa-medio);
            font-weight: 600;
        }

        /* ===== BOTONES ===== */
        .btn-primary {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, var(--rosa-medio), var(--rosa-fuerte));
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 1.1rem;
            cursor: pointer;
            transition: var(--transicion);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(231, 84, 128, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ===== MENSAJES ===== */
        .message-box {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .message-box.info {
            background: #cfe2ff;
            color: #084298;
            border-left: 4px solid #0d6efd;
        }

        .message-box.success {
            background: #d1e7dd;
            color: #0f5132;
            border-left: 4px solid #198754;
        }

        .message-box.warning {
            background: #fff3cd;
            color: #664d03;
            border-left: 4px solid #ffc107;
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .stepper {
                flex-wrap: wrap;
                gap: 10px;
            }

            .step-arrow {
                display: none;
            }

            .turnera-title h1 {
                font-size: 2rem;
            }

            .time-slots {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
                gap: 10px;
            }
        }

        /* ===== LOADING ===== */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--texto-medio);
        }

        .spinner {
            border: 4px solid var(--gris-claro);
            border-top: 4px solid var(--rosa-medio);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- ===== HEADER ===== -->
    <header class="header-turnera">
        <div class="container">
            <div class="logo-turnera">
                <a href="/studio.html">
                    <div class="logo-text">Luminance<span class="logo-dot">.</span></div>
                    <div class="logo-subtitle">Sistema de Turnos</div>
                </a>
                <a href="/studio.html" class="btn-volver">
                    <i class="fas fa-arrow-left"></i>
                    Volver al Inicio
                </a>
            </div>
        </div>
    </header>
    
    <!-- ===== MAIN CONTENT ===== -->
    <main class="main-turnera">
        <div class="container">
            <div class="turnera-title">
                <h1>üìÖ Reserva tu Turno Online</h1>
                <p>Segu√≠ los pasos para reservar tu turno</p>
            </div>

            <!-- ===== STEPPER ===== -->
            <div class="stepper">
                <div class="step" id="step-1">
                    <div class="step-number">1</div>
                    <div class="step-label">Fecha</div>
                </div>
                <div class="step-arrow">‚Üí</div>
                <div class="step" id="step-2">
                    <div class="step-number">2</div>
                    <div class="step-label">Servicio</div>
                </div>
                <div class="step-arrow">‚Üí</div>
                <div class="step" id="step-3">
                    <div class="step-number">3</div>
                    <div class="step-label">Horario</div>
                </div>
                <div class="step-arrow">‚Üí</div>
                <div class="step" id="step-4">
                    <div class="step-number">4</div>
                    <div class="step-label">Confirmar</div>
                </div>
            </div>

            <!-- ===== PASO 1: SELECCIONAR FECHA ===== -->
            <div class="section-box" id="section-date">
                <div class="section-header">
                    <div class="section-icon"><i class="fas fa-calendar"></i></div>
                    <h2>Paso 1: Selecciona una Fecha</h2>
                </div>
                <div class="message-box info">
                    <i class="fas fa-info-circle"></i>
                    <span>Hac√© click en el d√≠a que prefieras para tu turno. Los d√≠as con turnos confirmados se muestran en rojo.</span>
                </div>
                <div style="display: flex; gap: 20px; justify-content: center; margin-bottom: 20px; flex-wrap: wrap;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 12px; height: 12px; background: #dc3545; border-radius: 50%;"></div>
                        <span style="font-size: 0.9rem; color: var(--texto-medio);">Turno Confirmado</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 12px; height: 12px; background: rgba(231, 84, 128, 0.3); border: 2px solid var(--rosa-medio); border-radius: 50%;"></div>
                        <span style="font-size: 0.9rem; color: var(--texto-medio);">Disponible</span>
                    </div>
                </div>
                <div id="calendar"></div>
            </div>

            <!-- ===== PASO 2: SELECCIONAR SERVICIO ===== -->
            <div class="section-box disabled" id="section-service">
                <div class="section-header">
                    <div class="section-icon"><i class="fas fa-sparkles"></i></div>
                    <h2>Paso 2: Selecciona un Servicio</h2>
                </div>
                <div id="preselected-message" class="message-box success" style="display: none;">
                    <i class="fas fa-check-circle"></i>
                    <span>Servicio pre-seleccionado desde la p√°gina principal. Puedes cambiarlo si lo deseas.</span>
                </div>
                <div id="services-list" class="service-selector">
                    <div class="loading">
                        <div class="spinner"></div>
                        Cargando servicios...
                    </div>
                </div>
            </div>

            <!-- ===== PASO 3: SELECCIONAR HORARIO ===== -->
            <div class="section-box disabled" id="section-time">
                <div class="section-header">
                    <div class="section-icon"><i class="fas fa-clock"></i></div>
                    <h2>Paso 3: Selecciona un Horario</h2>
                </div>
                <div id="time-slots-container" class="time-slots">
                    <div class="loading">
                        <div class="spinner"></div>
                        Seleccion√° un servicio para ver horarios disponibles
                    </div>
                </div>
            </div>

            <!-- ===== PASO 4: RESUMEN Y CONFIRMACI√ìN ===== -->
            <div class="section-box disabled" id="section-summary">
                <div class="section-header">
                    <div class="section-icon"><i class="fas fa-check-circle"></i></div>
                    <h2>Paso 4: Resumen de tu Reserva</h2>
                </div>
                
                <div class="summary-box" id="summary-content">
                    <!-- Se llena din√°micamente -->
                </div>

                <div class="message-box warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <div>
                        <strong>Importante:</strong> Al confirmar se crear√° tu reserva con estado "Pendiente de Pago". 
                        Deber√°s completar el pago para que tu turno quede confirmado.
                    </div>
                </div>

                <button id="btn-confirm" class="btn-primary" disabled>
                    <i class="fas fa-calendar-check"></i>
                    Confirmar Reserva
                </button>
            </div>
        </div>
    </main>
    
    <!-- ===== SCRIPTS ===== -->
    <script src="api.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>
    
    <script>
        // ===== VERIFICAR AUTENTICACI√ìN =====
        requireAuth();

        // ===== VARIABLES GLOBALES =====
        let calendar = null;
        let selectedDate = null;
        let selectedServiceId = null;
        let selectedService = null;
        let selectedTime = null;
        let availableServices = [];

        // ===== INICIALIZAR =====
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ Inicializando turnera...');
            
            // Verificar si viene con servicio pre-seleccionado
            const preSelectedServiceId = localStorage.getItem('selected_service_id');
            if (preSelectedServiceId) {
                console.log('üìå Servicio pre-seleccionado desde studio.html:', preSelectedServiceId);
            }
            
            // Cargar servicios
            await loadServices();
            
            // Inicializar calendario (ahora es async)
            await initCalendar();

            // Configurar bot√≥n de confirmaci√≥n
            document.getElementById('btn-confirm').addEventListener('click', confirmReservation);
        });

        // ===== CARGAR SERVICIOS =====
        async function loadServices() {
            try {
                console.log('üì• Cargando servicios...');
                availableServices = await getServices();
                console.log('‚úÖ Servicios cargados:', availableServices.length);
                renderServices();
            } catch (error) {
                console.error('‚ùå Error cargando servicios:', error);
                document.getElementById('services-list').innerHTML = `
                    <div class="message-box warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>Error al cargar servicios. Por favor, recarga la p√°gina.</span>
                    </div>
                `;
            }
        }

        // ===== RENDERIZAR SERVICIOS =====
        function renderServices() {
            const container = document.getElementById('services-list');
            
            if (availableServices.length === 0) {
                container.innerHTML = `
                    <div class="message-box info">
                        <i class="fas fa-info-circle"></i>
                        <span>No hay servicios disponibles en este momento.</span>
                    </div>
                `;
                return;
            }

            container.innerHTML = availableServices.map(service => `
                <div class="service-option" data-service-id="${service.id}" onclick="selectService(${service.id})">
                    <div class="service-info">
                        <h4>${service.name}</h4>
                        <div class="service-details">
                            <span><i class="fas fa-clock"></i> ${service.duration_minutes} min</span>
                        </div>
                    </div>
                    <div class="service-price">${formatPrice(service.price)}</div>
                </div>
            `).join('');

            console.log('‚úÖ Servicios renderizados');
        }

        // ===== INICIALIZAR CALENDARIO =====
        async function initCalendar() {
            const calendarEl = document.getElementById('calendar');
            
            // Cargar turnos existentes para mostrar en el calendario
            let existingAppointments = [];
            try {
                existingAppointments = await loadExistingAppointments();
            } catch (error) {
                console.error('‚ö†Ô∏è No se pudieron cargar turnos existentes:', error);
            }
            
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'es',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: ''
                },
                validRange: {
                    start: new Date().toISOString().split('T')[0] // Solo fechas futuras
                },
                events: existingAppointments, // Mostrar turnos existentes
                dateClick: function(info) {
                    handleDateClick(info);
                },
                eventContent: function(arg) {
                    // Personalizar c√≥mo se muestran los eventos
                    return {
                        html: `<div style="font-size: 0.7rem; padding: 2px;">
                                <i class="fas fa-circle" style="font-size: 0.5rem;"></i> 
                                ${arg.event.title}
                               </div>`
                    };
                }
            });
            
            calendar.render();
            console.log('üìÖ Calendario inicializado con', existingAppointments.length, 'turnos');
        }

        // ===== CARGAR TURNOS EXISTENTES =====
        async function loadExistingAppointments() {
            try {
                // Verificar si getAppointments est√° disponible
                if (typeof getAppointments !== 'function') {
                    console.warn('‚ö†Ô∏è getAppointments no disponible en api.js');
                    return [];
                }
                
                // Obtener todos los turnos
                const appointments = await getAppointments();
                
                console.log('üìã Turnos existentes cargados:', appointments.length);
                
                // Guardar confirmados globalmente para doble chequeo de disponibilidad
                window._confirmedAppointments = appointments.filter(a => a.status === 'confirmed');
                console.log('üîí Turnos confirmados en memoria:', window._confirmedAppointments.length);

                // Convertir a formato de FullCalendar
                return window._confirmedAppointments
                    .filter(apt => {
                        return apt.status === 'confirmed';
                    })
                    .map(apt => {
                        const appointmentDate = new Date(apt.appointment_date);
                        
                        // Formatear hora
                        const hours = appointmentDate.getHours().toString().padStart(2, '0');
                        const minutes = appointmentDate.getMinutes().toString().padStart(2, '0');
                        const timeStr = `${hours}:${minutes}`;
                        
                        // Nombre del servicio (acortado si es muy largo)
                        const serviceName = apt.service.name.length > 20 
                            ? apt.service.name.substring(0, 20) + '...'
                            : apt.service.name;
                        
                        return {
                            id: apt.id,
                            title: `${timeStr} ${serviceName}`, // Formato: "14:30 Lifting de Pesta√±as"
                            start: appointmentDate.toISOString(),
                            backgroundColor: '#dc3545', // Rojo para confirmados
                            borderColor: '#bd2130',
                            textColor: '#ffffff',
                            extendedProps: {
                                serviceId: apt.service_id,
                                status: apt.status,
                                fullServiceName: apt.service.name,
                                time: timeStr
                            }
                        };
                    });
            } catch (error) {
                console.error('‚ùå Error cargando turnos existentes:', error);
                // No lanzar error, simplemente retornar array vac√≠o
                return [];
            }
        }

        // ===== MANEJAR CLICK EN FECHA =====
        function handleDateClick(info) {
            const clickedDate = new Date(info.dateStr + 'T00:00:00');
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // No permitir fechas pasadas
            if (clickedDate < today) {
                alert('No puedes seleccionar fechas pasadas');
                return;
            }

            // Remover selecci√≥n anterior
            document.querySelectorAll('.fc-daygrid-day').forEach(day => {
                day.classList.remove('selected-date');
            });

            // Marcar nueva selecci√≥n
            info.dayEl.classList.add('selected-date');
            
            selectedDate = info.dateStr;
            console.log('üìÖ Fecha seleccionada:', selectedDate);

            // Activar paso 2
            activateStep(2);
            document.getElementById('section-service').classList.remove('disabled');

            // Verificar si hay servicio pre-seleccionado de studio.html
            const preSelectedServiceId = localStorage.getItem('selected_service_id');
            const isValidPreSelection = preSelectedServiceId 
                && preSelectedServiceId !== 'undefined' 
                && preSelectedServiceId !== 'null'
                && !isNaN(parseInt(preSelectedServiceId));

            if (isValidPreSelection) {
                console.log('üéØ Auto-seleccionando servicio pre-seleccionado:', preSelectedServiceId);
                localStorage.removeItem('selected_service_id');
                setTimeout(() => {
                    selectService(parseInt(preSelectedServiceId));
                }, 100);
            } else {
                // Limpiar cualquier valor inv√°lido en localStorage
                localStorage.removeItem('selected_service_id');
                // Scroll suave a la secci√≥n de servicios
                document.getElementById('section-service').scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'start' 
                });
            }

            // Reset pasos siguientes
            resetStepsFrom(3);
        }

        // ===== SELECCIONAR SERVICIO =====
        async function selectService(serviceId) {
            // Remover selecci√≥n anterior
            document.querySelectorAll('.service-option').forEach(opt => {
                opt.classList.remove('selected');
            });

            // Marcar nuevo servicio
            const serviceElement = document.querySelector(`[data-service-id="${serviceId}"]`);
            if (serviceElement) {
                serviceElement.classList.add('selected');
            }

            selectedServiceId = serviceId;
            selectedService = availableServices.find(s => s.id === serviceId);
            console.log('üíÖ Servicio seleccionado:', selectedService.name);

            // Verificar si era pre-seleccionado
            const wasPreSelected = localStorage.getItem('selected_service_id');
            if (wasPreSelected && parseInt(wasPreSelected) === serviceId) {
                // Mostrar mensaje de pre-selecci√≥n
                const messageEl = document.getElementById('preselected-message');
                if (messageEl) {
                    messageEl.style.display = 'flex';
                }
            }

            // Activar paso 3
            activateStep(3);
            document.getElementById('section-time').classList.remove('disabled');

            // Cargar horarios disponibles
            await loadAvailableSlots();

            // Scroll suave a horarios
            setTimeout(() => {
                document.getElementById('section-time').scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'start' 
                });
            }, 100);

            // Reset paso 4
            resetStepsFrom(4);
        }

        // ===== CARGAR HORARIOS DISPONIBLES =====
        async function loadAvailableSlots() {
            const container = document.getElementById('time-slots-container');
            container.innerHTML = '<div class="loading"><div class="spinner"></div>Cargando horarios...</div>';

            try {
                console.log(`üïê Cargando horarios para ${selectedDate} y servicio ${selectedServiceId}`);
                const data = await getAvailableSlots(selectedServiceId, selectedDate);
                
                console.log('‚úÖ Horarios recibidos:', data);

                if (!data.available_slots || data.available_slots.length === 0) {
                    container.innerHTML = `
                        <div class="message-box info" style="grid-column: 1/-1;">
                            <i class="fas fa-info-circle"></i>
                            <span>No hay horarios disponibles para esta fecha. Por favor, selecciona otro d√≠a.</span>
                        </div>
                    `;
                    return;
                }

                // Filtrar horarios que el backend marc√≥ como disponibles
                let availableSlots = data.available_slots.filter(slot => slot.is_available);

                // ‚îÄ‚îÄ DOBLE CHEQUEO FRONTEND ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                // El backend a veces no actualiza is_available en tiempo real.
                // Cruzamos con los turnos confirmados que ya tenemos en memoria.
                if (window._confirmedAppointments && window._confirmedAppointments.length > 0) {
                    const durationMs = (selectedService?.duration_minutes || 60) * 60 * 1000;

                    availableSlots = availableSlots.filter(slot => {
                        const slotStart = new Date(slot.start_time).getTime();
                        const slotEnd   = slotStart + durationMs;

                        const ocupado = window._confirmedAppointments.some(apt => {
                            const aptStart = new Date(apt.appointment_date).getTime();
                            const aptEnd   = aptStart + durationMs;
                            // Hay solapamiento si los rangos se tocan
                            return aptStart < slotEnd && aptEnd > slotStart;
                        });

                        if (ocupado) console.log(`üî¥ Bloqueado por turno confirmado: ${slot.start_time}`);
                        return !ocupado;
                    });
                }
                // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

                // Si es el d√≠a actual, filtrar horarios que ya pasaron
                const today = new Date();
                const selectedDateObj = new Date(selectedDate + 'T00:00:00');
                
                // Normalizar fechas para comparar solo d√≠a/mes/a√±o
                today.setHours(0, 0, 0, 0);
                selectedDateObj.setHours(0, 0, 0, 0);
                
                if (selectedDateObj.getTime() === today.getTime()) {
                    // Es el d√≠a actual - filtrar horarios pasados
                    const now = new Date(); // Hora actual real
                    
                    availableSlots = availableSlots.filter(slot => {
                        const slotTime = new Date(slot.start_time);
                        return slotTime > now; // Solo horarios futuros
                    });
                    
                    console.log('üìÖ D√≠a actual - filtrados horarios pasados. Disponibles:', availableSlots.length);
                }

                if (availableSlots.length === 0) {
                    const isToday = selectedDateObj.getTime() === today.getTime();
                    container.innerHTML = `
                        <div class="message-box warning" style="grid-column: 1/-1;">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span>${isToday 
                                ? 'No hay m√°s horarios disponibles para hoy. Por favor, selecciona otro d√≠a.' 
                                : 'Todos los horarios est√°n ocupados para esta fecha. Intenta con otro d√≠a.'}</span>
                        </div>
                    `;
                    return;
                }

                // Renderizar horarios
                container.innerHTML = availableSlots.map(slot => {
                    const time = formatTime(slot.start_time);
                    return `
                        <div class="time-slot" onclick="selectTime('${slot.start_time}', this)">
                            ${time}
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('‚ùå Error cargando horarios:', error);
                container.innerHTML = `
                    <div class="message-box warning" style="grid-column: 1/-1;">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>Error al cargar horarios. Por favor, intenta nuevamente.</span>
                    </div>
                `;
            }
        }

        // ===== SELECCIONAR HORARIO =====
        function selectTime(dateTime, element) {
            // Remover selecci√≥n anterior
            document.querySelectorAll('.time-slot').forEach(slot => {
                slot.classList.remove('selected');
            });

            // Marcar nuevo horario (usando el elemento pasado como par√°metro)
            if (element) element.classList.add('selected');

            selectedTime = dateTime;
            console.log('üïê Horario seleccionado:', selectedTime);

            // Activar paso 4
            activateStep(4);
            document.getElementById('section-summary').classList.remove('disabled');

            // Mostrar resumen
            showSummary();

            // Scroll suave a resumen
            setTimeout(() => {
                document.getElementById('section-summary').scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'start' 
                });
            }, 100);

            // Habilitar bot√≥n de confirmaci√≥n
            document.getElementById('btn-confirm').disabled = false;
        }

        // ===== MOSTRAR RESUMEN =====
        function showSummary() {
            const summaryContent = document.getElementById('summary-content');
            
            const dateObj = new Date(selectedDate + 'T00:00:00');
            const formattedDate = dateObj.toLocaleDateString('es-ES', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });

            const timeFormatted = formatTime(selectedTime);

            summaryContent.innerHTML = `
                <div class="summary-item">
                    <span class="summary-label"><i class="fas fa-calendar"></i> Fecha:</span>
                    <span class="summary-value">${formattedDate}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label"><i class="fas fa-clock"></i> Horario:</span>
                    <span class="summary-value">${timeFormatted}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label"><i class="fas fa-sparkles"></i> Servicio:</span>
                    <span class="summary-value">${selectedService.name}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label"><i class="fas fa-hourglass"></i> Duraci√≥n:</span>
                    <span class="summary-value">${selectedService.duration_minutes} minutos</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label"><i class="fas fa-dollar-sign"></i> Precio:</span>
                    <span class="summary-value">${formatPrice(selectedService.price)}</span>
                </div>
            `;
        }

        // ===== CONFIRMAR RESERVA =====
        async function confirmReservation() {
            const btn = document.getElementById('btn-confirm');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';

            let appointmentCreatedId = null; // Para el fallback del catch

            try {
                console.log('üì§ Creando appointment...');
                console.log('üìå selectedServiceId:', selectedServiceId, typeof selectedServiceId);
                console.log('üìå selectedTime:', selectedTime, typeof selectedTime);
                console.log('üìå selectedDate:', selectedDate, typeof selectedDate);
                
                // Asegurar que service_id sea n√∫mero
                const serviceIdNum = parseInt(selectedServiceId);
                
                // ‚úÖ IMPORTANTE: El backend espera la fecha con timezone expl√≠cito.
                // Convertimos el string "2026-02-12T11:00:00" a un objeto Date
                // y luego lo formateamos con el offset local (ej: -03:00 para Argentina)
                // para que el backend sepa exactamente qu√© hora es.
                const appointmentDateTime = toLocalISOString(new Date(selectedTime));
                console.log('üïê Fecha con timezone:', appointmentDateTime);
                
                const appointmentData = {
                    service_id: serviceIdNum,
                    appointment_date: appointmentDateTime,
                    notes: ''
                };
                
                console.log('üì¶ Datos a enviar:', JSON.stringify(appointmentData, null, 2));

                const appointment = await createAppointment(appointmentData);
                appointmentCreatedId = appointment.id; // Guardar por si falla algo despu√©s
                console.log('‚úÖ Appointment creado:', appointment);

                // Actualizar el calendario con el nuevo turno
                // Usamos selectedService (ya cargado en memoria) porque el backend
                // devuelve AppointmentResponse que solo tiene service_id, no el objeto completo
                if (calendar && selectedService) {
                    const appointmentDate = new Date(appointment.appointment_date);
                    calendar.addEvent({
                        id: appointment.id,
                        title: selectedService.name.substring(0, 15) + '...',
                        start: appointmentDate.toISOString(),
                        backgroundColor: '#ffc107',
                        borderColor: '#e0a800',
                        textColor: '#ffffff'
                    });
                }

                // Redirigir a p√°gina de pago
                window.location.href = `/pago.html?appointment_id=${appointment.id}`;

            } catch (error) {
                console.error('‚ùå Error:', error);

                // Si el error es de JS (TypeError) y el appointment ya fue creado,
                // igual redirigimos al pago ‚Äî el turno existe en el backend
                if (error instanceof TypeError && appointmentCreatedId) {
                    console.warn('‚ö†Ô∏è Error de JS pero appointment creado, redirigiendo...');
                    window.location.href = `/pago.html?appointment_id=${appointmentCreatedId}`;
                    return;
                }

                // Error real del backend
                let errorMessage = 'Error al crear la reserva.';
                if (error && error.message) {
                    errorMessage += `\n${error.message}`;
                }
                
                alert(errorMessage);
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-calendar-check"></i> Confirmar Reserva';
            }
        }

        // ===== FUNCIONES AUXILIARES =====
        function activateStep(stepNumber) {
            // Marcar paso como activo
            for (let i = 1; i <= stepNumber; i++) {
                const step = document.getElementById(`step-${i}`);
                if (i < stepNumber) {
                    step.classList.add('completed');
                    step.classList.remove('active');
                } else if (i === stepNumber) {
                    step.classList.add('active');
                    step.classList.remove('completed');
                }
            }
        }

        function resetStepsFrom(stepNumber) {
            for (let i = stepNumber; i <= 4; i++) {
                const step = document.getElementById(`step-${i}`);
                step.classList.remove('active', 'completed');
            }

            if (stepNumber <= 3) {
                selectedTime = null;
                document.getElementById('section-time').classList.add('disabled');
            }
            
            if (stepNumber <= 4) {
                document.getElementById('section-summary').classList.add('disabled');
                document.getElementById('btn-confirm').disabled = true;
            }
        }

        // ===== FUNCI√ìN: fecha local con timezone offset =====
        // Convierte un Date a ISO string con el offset local del navegador
        // Ej (UTC-3): "2026-02-12T11:00:00-03:00"
        // El backend Pydantic lo parsea correctamente con timezone.utc
        function toLocalISOString(date) {
            const pad = n => String(n).padStart(2, '0');
            
            const year   = date.getFullYear();
            const month  = pad(date.getMonth() + 1);
            const day    = pad(date.getDate());
            const hours  = pad(date.getHours());
            const mins   = pad(date.getMinutes());
            const secs   = pad(date.getSeconds());
            
            // Calcular offset (ej: -180 min ‚Üí "-03:00")
            const offsetMin = date.getTimezoneOffset(); // positivo = atr√°s de UTC
            const sign      = offsetMin <= 0 ? '+' : '-';
            const absOffset = Math.abs(offsetMin);
            const offH      = pad(Math.floor(absOffset / 60));
            const offM      = pad(absOffset % 60);
            
            return `${year}-${month}-${day}T${hours}:${mins}:${secs}${sign}${offH}:${offM}`;
        }

        // ===== FUNCIONES DE FORMATO (si no est√°n en api.js) =====
        if (typeof formatPrice === 'undefined') {
            function formatPrice(price) {
                return `$${price.toLocaleString('es-AR')}`;
            }
        }

        // Sobreescribimos siempre para garantizar "HH:MM hs" con 2 d√≠gitos (no depender de api.js)
        function formatTime(dateTimeString) {
            const date = new Date(dateTimeString);
            const h = String(date.getHours()).padStart(2, '0');
            const m = String(date.getMinutes()).padStart(2, '0');
            return `${h}:${m} hs`;
        }

        if (typeof formatDate === 'undefined') {
            function formatDate(dateTimeString) {
                const date = new Date(dateTimeString);
                return date.toLocaleDateString('es-ES');
            }
        }
    </script>
</body>
</html>
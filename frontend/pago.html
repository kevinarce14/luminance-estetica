<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confirmar Pago | Luminance Studio by Cande</title>
    <meta name="description" content="Completa el pago para confirmar tu turno">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Playfair+Display:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* ===== VARIABLES Y ESTILOS GLOBALES ===== */
        :root {
            --rosa-claro: #f8d7e6;
            --rosa-medio: #e75480;
            --rosa-fuerte: #d81b60;
            --lila-claro: #f4f0ff;
            --lila-medio: #9c89b8;
            --lila-oscuro: #7b4bbd;
            --violeta: #6a4c93;
            --dorado: #d4af37;
            --dorado-claro: #f1c40f;
            --blanco: #ffffff;
            --gris-claro: #f8f9fa;
            --gris-medio: #e9ecef;
            --texto-oscuro: #2d3436;
            --texto-medio: #636e72;
            --verde: #28a745;
            --sombra: 0 10px 30px rgba(0, 0, 0, 0.08);
            --sombra-hover: 0 20px 40px rgba(0, 0, 0, 0.12);
            --transicion: all 0.3s ease;
            --border-radius: 15px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, var(--rosa-claro) 0%, var(--lila-claro) 100%);
            color: var(--texto-oscuro);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        h1, h2, h3, h4 {
            font-family: 'Playfair Display', serif;
            font-weight: 700;
            line-height: 1.2;
        }
        
        /* ===== CONTAINER ===== */
        .payment-container {
            max-width: 900px;
            width: 100%;
            background: white;
            border-radius: 20px;
            box-shadow: var(--sombra-hover);
            overflow: hidden;
        }
        
        /* ===== HEADER ===== */
        .payment-header {
            background: linear-gradient(135deg, var(--rosa-medio), var(--lila-oscuro));
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .payment-header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .payment-header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }
        
        /* ===== CONTENT ===== */
        .payment-content {
            padding: 40px;
        }
        
        .payment-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        
        /* ===== RESUMEN DEL TURNO ===== */
        .appointment-summary {
            background: linear-gradient(135deg, var(--lila-claro), var(--rosa-claro));
            border-radius: var(--border-radius);
            padding: 30px;
        }
        
        .appointment-summary h2 {
            color: var(--violeta);
            font-size: 1.5rem;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: start;
            padding: 15px 0;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }
        
        .summary-item:last-child {
            border-bottom: none;
        }
        
        .summary-label {
            font-weight: 600;
            color: var(--texto-oscuro);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .summary-value {
            color: var(--texto-medio);
            text-align: right;
            font-weight: 500;
        }
        
        .summary-value.highlight {
            color: var(--rosa-medio);
            font-size: 1.3rem;
            font-weight: 700;
        }
        
        .status-badge {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            background: #fff3cd;
            color: #856404;
        }
        
        /* ===== M√âTODOS DE PAGO ===== */
        .payment-methods {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .payment-methods h2 {
            color: var(--violeta);
            font-size: 1.5rem;
            margin-bottom: 10px;
        }
        
        .payment-option {
            border: 2px solid var(--gris-medio);
            border-radius: var(--border-radius);
            padding: 20px;
            cursor: pointer;
            transition: var(--transicion);
            position: relative;
        }
        
        .payment-option:hover {
            border-color: var(--rosa-medio);
            background: var(--lila-claro);
            transform: translateY(-3px);
            box-shadow: var(--sombra);
        }
        
        .payment-option.selected {
            border-color: var(--rosa-medio);
            background: linear-gradient(135deg, var(--rosa-claro), var(--lila-claro));
        }
        
        .payment-option-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
        }
        
        .payment-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--rosa-medio), var(--lila-oscuro));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }
        
        .payment-option-title {
            flex: 1;
        }
        
        .payment-option-title h3 {
            color: var(--violeta);
            font-size: 1.2rem;
            margin-bottom: 5px;
        }
        
        .payment-option-title p {
            color: var(--texto-medio);
            font-size: 0.9rem;
        }
        
        .payment-option-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            background: var(--verde);
            color: white;
        }
        
        .payment-details {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(0,0,0,0.1);
            display: none;
        }
        
        .payment-option.selected .payment-details {
            display: block;
        }
        
        .transfer-info {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        
        .transfer-info-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed var(--gris-medio);
        }
        
        .transfer-info-item:last-child {
            border-bottom: none;
        }
        
        .copy-button {
            background: var(--lila-medio);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: var(--transicion);
        }
        
        .copy-button:hover {
            background: var(--lila-oscuro);
        }
        
        .file-upload {
            margin-top: 15px;
        }
        
        .file-upload label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--texto-oscuro);
        }
        
        .file-input-wrapper {
            position: relative;
            border: 2px dashed var(--gris-medio);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: var(--transicion);
        }
        
        .file-input-wrapper:hover {
            border-color: var(--rosa-medio);
            background: var(--lila-claro);
        }
        
        .file-input-wrapper input[type="file"] {
            position: absolute;
            opacity: 0;
            cursor: pointer;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
        }
        
        .file-preview {
            margin-top: 10px;
            padding: 10px;
            background: var(--verde);
            color: white;
            border-radius: 8px;
            display: none;
        }
        
        /* ===== BOTONES DE ACCI√ìN ===== */
        .payment-actions {
            margin-top: 30px;
            display: flex;
            gap: 15px;
        }
        
        .btn {
            flex: 1;
            padding: 16px 30px;
            border: none;
            border-radius: 50px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: var(--transicion);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--rosa-medio), var(--rosa-fuerte));
            color: white;
            box-shadow: 0 6px 20px rgba(231, 84, 128, 0.3);
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 12px 25px rgba(231, 84, 128, 0.4);
        }
        
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: var(--gris-medio);
            color: var(--texto-oscuro);
        }
        
        .btn-secondary:hover {
            background: var(--gris-oscuro);
            color: white;
        }
        
        /* ===== ALERTAS ===== */
        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .alert-info {
            background: #cfe2ff;
            color: #084298;
            border-left: 4px solid #0d6efd;
        }
        
        .alert-warning {
            background: #fff3cd;
            color: #664d03;
            border-left: 4px solid #ffc107;
        }
        
        .alert-success {
            background: #d1e7dd;
            color: #0f5132;
            border-left: 4px solid #198754;
        }
        
        /* ===== LOADING ===== */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
        
        .loading-overlay.active {
            display: flex;
        }
        
        .loading-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
        }
        
        .spinner {
            border: 4px solid var(--gris-claro);
            border-top: 4px solid var(--rosa-medio);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .payment-grid {
                grid-template-columns: 1fr;
            }
            
            .payment-content {
                padding: 20px;
            }
            
            .payment-header h1 {
                font-size: 1.5rem;
            }
            
            .payment-actions {
                flex-direction: column;
            }
        }

        
    </style>
    <link rel="stylesheet" href="responsive.css">
</head>
<body>
    <!-- ===== LOADING OVERLAY ===== -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <h3>Procesando pago...</h3>
            <p>Por favor espera un momento</p>
        </div>
    </div>

    <!-- ===== MAIN CONTAINER ===== -->
    <div class="payment-container">
        <!-- ===== HEADER ===== -->
        <div class="payment-header">
            <h1>üí≥ Confirmar tu Turno</h1>
            <p>Completa el pago para confirmar tu reserva</p>
        </div>
        
        <!-- ===== CONTENT ===== -->
        <div class="payment-content">
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle"></i>
                <div>
                    <strong>Importante:</strong> Tu turno est√° <strong>reservado temporalmente</strong> con estado "Pendiente". 
                    Una vez acreditado el pago, recibir√°s un email de confirmaci√≥n.
                </div>
            </div>
            
            <div class="payment-grid">
                <!-- ===== RESUMEN DEL TURNO ===== -->
                <div class="appointment-summary">
                    <h2>
                        <i class="fas fa-calendar-check"></i>
                        Resumen del Turno
                    </h2>
                    
                    <div id="appointment-summary">
                        <!-- Se llena din√°micamente -->
                        <div class="loading">
                            <div class="spinner"></div>
                            Cargando informaci√≥n...
                        </div>
                    </div>
                </div>
                
                <!-- ===== M√âTODOS DE PAGO ===== -->
                <div class="payment-methods">
                    <h2>M√©todo de Pago</h2>
                    
                    <!-- MERCADO PAGO -->
                    <div class="payment-option" id="option-mercadopago" onclick="selectPaymentMethod('mercadopago')">
                        <div class="payment-option-header">
                            <div class="payment-icon">
                                <i class="fas fa-credit-card"></i>
                            </div>
                            <div class="payment-option-title">
                                <h3>Mercado Pago</h3>
                                <p>Pago online con tarjeta o transferencia</p>
                            </div>
                            <span class="payment-option-badge">Recomendado</span>
                        </div>
                        <div class="payment-details">
                            <p style="margin-bottom: 15px; color: var(--texto-medio);">
                                Ser√°s redirigido a Mercado Pago para completar el pago de forma segura.
                            </p>
                        </div>
                    </div>
                    
                    <!-- TRANSFERENCIA BANCARIA -->
                    <div class="payment-option" id="option-transfer" onclick="selectPaymentMethod('transfer')">
                        <div class="payment-option-header">
                            <div class="payment-icon">
                                <i class="fas fa-university"></i>
                            </div>
                            <div class="payment-option-title">
                                <h3>Transferencia Bancaria</h3>
                                <p>Transferencia o dep√≥sito directo</p>
                            </div>
                        </div>
                        <div class="payment-details">
                            <div class="transfer-info">
                                <div class="transfer-info-item">
                                    <span><strong>Banco:</strong></span>
                                    <span>Banco Galicia</span>
                                </div>
                                <div class="transfer-info-item">
                                    <span><strong>Titular:</strong></span>
                                    <span>Candelaria L√≥pez</span>
                                </div>
                                <div class="transfer-info-item">
                                    <span><strong>CBU:</strong></span>
                                    <div style="display: flex; gap: 10px; align-items: center;">
                                        <span id="cbu-text">0070156030004017654321</span>
                                        <button class="copy-button" onclick="copyToClipboard('cbu-text', event)">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="transfer-info-item">
                                    <span><strong>Alias:</strong></span>
                                    <div style="display: flex; gap: 10px; align-items: center;">
                                        <span id="alias-text">LUMINANCE.CANDE</span>
                                        <button class="copy-button" onclick="copyToClipboard('alias-text', event)">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="file-upload">
                                <label>Subir comprobante de pago:</label>
                                <div class="file-input-wrapper">
                                    <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; color: var(--rosa-medio);"></i>
                                    <p style="margin-top: 10px;">Hac√© click o arrastr√° tu comprobante aqu√≠</p>
                                    <input type="file" id="file-input" accept="image/*,.pdf" onchange="handleFileUpload(event)">
                                </div>
                                <div class="file-preview" id="file-preview">
                                    <i class="fas fa-check-circle"></i>
                                    <span id="file-name"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- EFECTIVO EN PERSONA -->
                    <div class="payment-option" id="option-cash" onclick="selectPaymentMethod('cash')">
                        <div class="payment-option-header">
                            <div class="payment-icon">
                                <i class="fas fa-money-bill-wave"></i>
                            </div>
                            <div class="payment-option-title">
                                <h3>Efectivo en Persona</h3>
                                <p>Paga directamente en el estudio</p>
                            </div>
                        </div>
                        <div class="payment-details">
                            <div class="alert alert-info" style="margin: 0;">
                                <i class="fas fa-info-circle"></i>
                                <div>
                                    Podr√°s abonar en efectivo cuando llegues al turno. 
                                    Tu turno quedar√° confirmado igualmente.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ===== ACCIONES ===== -->
            <div class="payment-actions">
                <button class="btn btn-secondary" onclick="cancelReservation()">
                    <i class="fas fa-times"></i>
                    Cancelar Reserva
                </button>
                <button class="btn btn-primary" id="btn-confirm-payment" onclick="confirmPayment()" disabled>
                    <i class="fas fa-check-circle"></i>
                    Confirmar Pago
                </button>
            </div>
        </div>
    </div>
    
    <!-- ===== SCRIPTS ===== -->
    <script src="api.js"></script>
    
    <script>
        // ===== VERIFICAR AUTENTICACI√ìN =====
        requireAuth();

        // ===== FORMATO LOCAL (no depender de versi√≥n de api.js) =====
        function formatPrice(p) { return '$' + Number(p).toLocaleString('es-AR'); }
        function formatTime(s)  {
            const d = new Date(s);
            return String(d.getHours()).padStart(2,'0') + ':' + String(d.getMinutes()).padStart(2,'0') + ' hs';
        }
        
        // ===== VARIABLES GLOBALES =====
        let appointmentId = null;
        let appointmentData = null;
        let selectedPaymentMethod = null;
        let uploadedFile = null;
        
        // ===== INICIALIZAR =====
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üí≥ Inicializando p√°gina de pago...');
            
            // Obtener ID del appointment desde URL
            const urlParams = new URLSearchParams(window.location.search);
            appointmentId = urlParams.get('appointment_id');
            
            // ‚úÖ Verificar si estamos volviendo de MercadoPago
            const mpStatus = urlParams.get('collection_status') || urlParams.get('status');
            const mpPaymentId = urlParams.get('collection_id') || urlParams.get('payment_id');
            const externalRef = urlParams.get('external_reference');
            
            // Si venimos de MercadoPago con un pago aprobado
            if (mpStatus === 'approved' && externalRef) {
                console.log('‚úÖ Volviendo de MercadoPago con pago aprobado');
                console.log('üìå Payment ID:', mpPaymentId, 'Appointment:', externalRef);
                
                // Mostrar mensaje de verificaci√≥n
                document.body.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(135deg, #f8d7e6, #f4f0ff);">
                        <div style="background: white; border-radius: 20px; padding: 40px; text-align: center; max-width: 500px; box-shadow: 0 20px 60px rgba(0,0,0,0.1);">
                            <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #28a745, #20c963); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; font-size: 2.5rem; color: white;">
                                <i class="fas fa-check"></i>
                            </div>
                            <h2 style="color: #6a4c93; margin-bottom: 15px;">¬°Pago Confirmado!</h2>
                            <p style="color: #636e72; margin-bottom: 20px;">Redirigiendo a la confirmaci√≥n...</p>
                            <div style="border: 3px solid #f0f0f0; border-top: 3px solid #e75480; border-radius: 50%; width: 40px; height: 40px; animation: spin 0.8s linear infinite; margin: 0 auto;"></div>
                        </div>
                    </div>
                    <style>
                        @keyframes spin { to { transform: rotate(360deg); } }
                    </style>
                `;
                
                // Esperar 1 segundo y redirigir a pago-exitoso
                setTimeout(() => {
                    window.location.href = `/pago-exitoso.html?external_reference=${externalRef}&collection_status=approved&collection_id=${mpPaymentId}`;
                }, 1500);
                return;
            }
            
            // Si venimos con pago rechazado o pendiente
            if (mpStatus && (mpStatus === 'rejected' || mpStatus === 'failure')) {
                console.log('‚ùå Volviendo de MercadoPago con pago rechazado');
                if (externalRef) {
                    window.location.href = `/pago-fallido.html?external_reference=${externalRef}&status=${mpStatus}`;
                    return;
                }
            }
            
            if (!appointmentId) {
                alert('No se encontr√≥ informaci√≥n del turno');
                window.location.href = '/turnera.html';
                return;
            }
            
            console.log('üìå Appointment ID:', appointmentId);
            
            // Cargar datos del turno
            await loadAppointmentData();
        });
        
        // ===== CARGAR DATOS DEL TURNO =====
        async function loadAppointmentData() {
            const container = document.getElementById('appointment-summary');
            try {
                console.log('üì° Cargando turno ID:', appointmentId);
                appointmentData = await getAppointmentById(appointmentId);
                console.log('‚úÖ Datos del turno:', appointmentData);
                
                if (appointmentData.status !== 'pending') {
                    container.innerHTML = `
                        <div class="alert alert-warning">
                            <i class="fas fa-info-circle"></i>
                            <div>Este turno ya fue procesado (estado: <strong>${appointmentData.status}</strong>).
                            <br><a href="/mis-turnos.html" style="color:inherit;font-weight:700;">Ver mis turnos ‚Üí</a></div>
                        </div>`;
                    document.getElementById('btn-confirm-payment').disabled = true;
                    return;
                }
                renderAppointmentSummary();
                
            } catch (error) {
                console.error('‚ùå Error cargando datos del turno:', error);
                const msg = error?.message || error?.detail || JSON.stringify(error);
                container.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <div>
                            <strong>Error al cargar turno #${appointmentId}</strong><br>
                            <code>${msg}</code><br><br>
                            <button onclick="loadAppointmentData()" 
                                style="background:var(--rosa-medio);color:white;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;margin-right:10px;">
                                üîÑ Reintentar
                            </button>
                            <a href="/turnera.html" style="color:var(--rosa-medio);font-weight:600;">‚Üê Volver</a>
                        </div>
                    </div>`;
            }
        }
        
        // ===== RENDERIZAR RESUMEN =====
        function renderAppointmentSummary() {
            const container = document.getElementById('appointment-summary');
            
            const appointmentDate = new Date(appointmentData.appointment_date);
            const formattedDate = appointmentDate.toLocaleDateString('es-ES', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            const formattedTime = appointmentDate.toLocaleTimeString('es-ES', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: false 
            });
            
            container.innerHTML = `
                <div class="summary-item">
                    <div class="summary-label">
                        <i class="fas fa-tag"></i>
                        Estado
                    </div>
                    <div class="summary-value">
                        <span class="status-badge">‚è≥ Pendiente de Pago</span>
                    </div>
                </div>
                
                <div class="summary-item">
                    <div class="summary-label">
                        <i class="fas fa-sparkles"></i>
                        Servicio
                    </div>
                    <div class="summary-value">${appointmentData.service.name}</div>
                </div>
                
                <div class="summary-item">
                    <div class="summary-label">
                        <i class="fas fa-calendar"></i>
                        Fecha
                    </div>
                    <div class="summary-value">${formattedDate}</div>
                </div>
                
                <div class="summary-item">
                    <div class="summary-label">
                        <i class="fas fa-clock"></i>
                        Horario
                    </div>
                    <div class="summary-value">${formattedTime} hs</div>
                </div>
                
                <div class="summary-item">
                    <div class="summary-label">
                        <i class="fas fa-hourglass"></i>
                        Duraci√≥n
                    </div>
                    <div class="summary-value">${appointmentData.service.duration_minutes} minutos</div>
                </div>
                
                <div class="summary-item" style="margin-top: 15px; padding-top: 15px; border-top: 2px solid rgba(0,0,0,0.2);">
                    <div class="summary-label" style="font-size: 1.2rem;">
                        <i class="fas fa-dollar-sign"></i>
                        Total a Pagar
                    </div>
                    <div class="summary-value highlight">${formatPrice(appointmentData.service.price)}</div>
                </div>
            `;
        }
        
        // ===== SELECCIONAR M√âTODO DE PAGO =====
        function selectPaymentMethod(method) {
            // Remover selecci√≥n anterior
            document.querySelectorAll('.payment-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            // Marcar nuevo m√©todo
            document.getElementById(`option-${method}`).classList.add('selected');
            
            selectedPaymentMethod = method;
            console.log('üí≥ M√©todo de pago seleccionado:', method);
            
            // Habilitar bot√≥n de confirmaci√≥n
            const btnConfirm = document.getElementById('btn-confirm-payment');
            
            // Para transferencia, requerir comprobante
            if (method === 'transfer') {
                btnConfirm.disabled = !uploadedFile;
            } else {
                btnConfirm.disabled = false;
            }
        }
        
        // ===== COPIAR AL PORTAPAPELES =====
        function copyToClipboard(elementId, event) {
            event.stopPropagation();
            
            const text = document.getElementById(elementId).textContent;
            navigator.clipboard.writeText(text).then(() => {
                // Cambiar temporalmente el bot√≥n
                const btn = event.target.closest('.copy-button');
                const originalHTML = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i> Copiado';
                
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                }, 2000);
            });
        }
        
        // ===== MANEJAR SUBIDA DE ARCHIVO =====
        function handleFileUpload(event) {
            const file = event.target.files[0];
            
            if (file) {
                uploadedFile = file;
                
                // Mostrar preview
                const preview = document.getElementById('file-preview');
                const fileName = document.getElementById('file-name');
                
                fileName.textContent = file.name;
                preview.style.display = 'flex';
                
                // Habilitar bot√≥n si transferencia est√° seleccionada
                if (selectedPaymentMethod === 'transfer') {
                    document.getElementById('btn-confirm-payment').disabled = false;
                }
                
                console.log('üìé Archivo seleccionado:', file.name);
            }
        }
        
        // ===== CONFIRMAR PAGO =====
        async function confirmPayment() {
            if (!selectedPaymentMethod) {
                alert('Por favor, selecciona un m√©todo de pago');
                return;
            }
            
            // Mostrar loading
            document.getElementById('loadingOverlay').classList.add('active');
            
            try {
                console.log('üí≥ Procesando pago con m√©todo:', selectedPaymentMethod);
                
                if (selectedPaymentMethod === 'mercadopago') {
                    // MERCADO PAGO
                    await handleMercadoPagoPayment();
                    
                } else if (selectedPaymentMethod === 'transfer') {
                    // TRANSFERENCIA
                    await handleTransferPayment();
                    
                } else if (selectedPaymentMethod === 'cash') {
                    // EFECTIVO
                    await handleCashPayment();
                }
                
            } catch (error) {
                console.error('‚ùå Error procesando pago:', error);
                document.getElementById('loadingOverlay').classList.remove('active');
                
                // Extraer mensaje detallado ‚Äî el 422 de Pydantic viene como Array
                let msg = '';
                if (Array.isArray(error?.message)) {
                    // Pydantic validation error: [{loc, msg, type}, ...]
                    msg = error.message.map(e => `Campo '${e.loc?.join('.')}': ${e.msg}`).join('\n');
                    console.error('‚ùå Validaci√≥n Pydantic:', error.message);
                } else {
                    msg = error?.message || error?.detail || JSON.stringify(error);
                }
                
                alert(`Error (${error?.status || '?'}):\n${msg}`);
            }
        }
        
        // ===== PROCESAR PAGO CON MERCADO PAGO =====
        async function handleMercadoPagoPayment() {
            try {
                // Llamar al backend para crear preferencia de MP
                const response = await createMercadoPagoPreference(appointmentId);
                
                console.log('‚úÖ Preferencia de MP creada:', response);
                
                // Redirigir a Mercado Pago
                if (response.init_point) {
                    window.location.href = response.init_point;
                } else {
                    throw new Error('No se recibi√≥ URL de pago');
                }
                
            } catch (error) {
                console.error('‚ùå Error con Mercado Pago:', error);
                throw error;
            }
        }
        
        // ===== PROCESAR TRANSFERENCIA =====
        async function handleTransferPayment() {
            try {
                // Registrar el pago como transferencia pendiente
                // El admin lo aprueba luego via PUT /payments/{id}/status
                const amount = appointmentData?.service?.price ?? appointmentData?.price ?? 0;
                
                console.log('üîç POST /payments/create-preference/ (transfer)');
                await apiRequest('/payments/create-preference/', {
                    method: 'POST',
                    body: {
                        appointment_id: parseInt(appointmentId),
                        amount: parseFloat(amount),
                        currency: 'ARS',
                        payment_method: 'transfer'
                    }
                });
                
                document.getElementById('loadingOverlay').classList.remove('active');
                alert('¬°Datos recibidos! Una vez que verifiquemos tu transferencia, confirmaremos el turno y recibir√°s un email.');
                window.location.href = '/mis-turnos.html';
                
            } catch (error) {
                console.error('‚ùå Error registrando transferencia:', error);
                throw error;
            }
        }
        
        // ===== PROCESAR PAGO EN EFECTIVO =====
        async function handleCashPayment() {
            try {
                // El backend no tiene endpoint espec√≠fico de cash.
                // Creamos el Payment con method=cash (queda en PENDING hasta que admin lo apruebe)
                // y confirmamos el appointment directamente via PATCH.
                const amount = appointmentData?.service?.price ?? appointmentData?.price ?? 0;
                
                console.log('üîç POST /payments/create-preference/ (cash)');
                await apiRequest('/payments/create-preference/', {
                    method: 'POST',
                    body: {
                        appointment_id: parseInt(appointmentId),
                        amount: parseFloat(amount),
                        currency: 'ARS',
                        payment_method: 'cash'
                    }
                });
                
                // Confirmar el appointment directamente
                console.log('üîç PATCH /appointments/' + appointmentId + '/');
                await apiRequest(`/appointments/${appointmentId}/`, {
                    method: 'PATCH',
                    body: { status: 'confirmed' }
                });
                
                document.getElementById('loadingOverlay').classList.remove('active');
                alert('¬°Turno confirmado! Podr√°s abonar en efectivo cuando llegues. Te esperamos üòä');
                window.location.href = '/mis-turnos.html';
                
            } catch (error) {
                console.error('‚ùå Error confirmando turno en efectivo:', error);
                throw error;
            }
        }
        
        // ===== CANCELAR RESERVA =====
        async function cancelReservation() {
            const confirm = window.confirm('¬øEst√°s seguro de que quieres cancelar esta reserva?');
            
            if (!confirm) return;
            
            try {
                document.getElementById('loadingOverlay').classList.add('active');
                
                await cancelAppointment(appointmentId, 'Cancelado desde p√°gina de pago');
                
                console.log('‚úÖ Reserva cancelada');
                
                alert('Reserva cancelada correctamente');
                window.location.href = '/turnera.html';
                
            } catch (error) {
                console.error('‚ùå Error cancelando reserva:', error);
                alert('Error al cancelar la reserva');
                document.getElementById('loadingOverlay').classList.remove('active');
            }
        }
        
        // ===== FUNCIONES AUXILIARES DE API =====
        // Todas usan apiRequest (funci√≥n p√∫blica de api.js, igual que en turnera.html)

        async function getAppointmentById(id) {
            console.log('üîç GET /appointments/' + id + '/');
            return await apiRequest(`/appointments/${id}/`);
        }
        
        async function createMercadoPagoPreference(id) {
            console.log('üîç POST /payments/create-preference/');
            // PaymentCreate requiere: appointment_id, amount, currency, payment_method
            const amount = appointmentData?.service?.price ?? appointmentData?.price ?? 0;
            return await apiRequest('/payments/create-preference/', {
                method: 'POST',
                body: {
                    appointment_id: parseInt(id),
                    amount: parseFloat(amount),
                    currency: 'ARS',
                    payment_method: 'mercadopago'
                }
            });
        }
        
        // uploadPaymentProof: endpoint no implementado en el backend todav√≠a.
        // La transferencia se registra via POST /payments/create-preference/ con method=transfer.
        
        async function confirmAppointmentCash(id) {
            // Wrapper ‚Äî ya no se llama directamente, handleCashPayment lo reemplaz√≥
            return await apiRequest(`/appointments/${id}/`, {
                method: 'PATCH',
                body: { status: 'confirmed' }
            });
        }
    </script>
</body>
</html>